# 股票交易系统 - 数据库实体设计
## 0. 数据库设计规范

### 0.1 数据库命名规范
- **数据库命名规范**：使用下划线分隔的小写字母命名，例如：`user_table`
- **表字段命名规范**：使用下划线分隔的小写字母命名，例如：`user_id`
- **主键命名规范**：使用 `id` 作为主键字段名
- **索引命名规范**：使用 `idx_` 前缀加上索引字段名，例如：`idx_user_id`
- **外键命名规范**：使用 `fk_` 前缀加上外键字段名，例如：`fk_user_id`，所有外键都注释上关联的表和字段
- **约束命名规范**：不使用

### 0.1 数据库字段类型规范
- **整数类型**：使用`BIGINT`，根据数据范围选择。
- **字符串类型**：使用 `VARCHAR` 或 `TEXT`，根据数据长度选择。
- **日期时间类型**：统一使用`DATETIME`类型，存储日期时间信息。
- **枚举类型**：不使用枚举类型，使用字符串类型+注释替代。
- **JSON 类型**：不使用 `JSON`，使用TEXT替代。
- **Blob 类型**：不使用Blob类型，使用字符串替代。
- **索引类型**：根据查询频率和数据量选择合适的索引类型（B-tree、哈希索引等）。

### 0.2 分表规范
- **分表策略**：先不分表

## 1. 数据库配置

### 1.1 数据库基本信息
- **数据库类型**：MySQL 8.0+
- **字符集**：utf8mb4
- **排序规则**：utf8mb4_unicode_ci
- **存储引擎**：InnoDB
- **时区设置**：Asia/Shanghai

### 1.2 连接池配置
- 最小连接数：5
- 最大连接数：50
- 连接超时：30 秒
- 空闲连接超时：300 秒

## 2. 数据库表设计

### 2.1 任务基础表（tasks）

#### 2.1.1 表结构
```sql
CREATE TABLE `tasks` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '任务 ID（主键）',
  `task_id` VARCHAR(36) NOT NULL COMMENT '任务唯一标识（UUID）',
  `task_name` VARCHAR(255) NOT NULL COMMENT '任务名称',
  `task_description` TEXT COMMENT '任务描述',
  `task_type` VARCHAR(50) NOT NULL COMMENT '任务类型：stock_selection-选股任务，batch_backtest-批量回测任务，single_backtest-个股回测任务',
  `status` VARCHAR(50) DEFAULT 'pending' COMMENT '任务状态：pending-待执行，running-执行中，completed-已完成，failed-失败，cancelled-已取消',
  `priority` BIGINT UNSIGNED DEFAULT 5 COMMENT '任务优先级（1-10）',
  `created_by` VARCHAR(36) COMMENT '创建用户 ID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_by` VARCHAR(36) COMMENT '最后修改用户 ID',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后修改时间',
  `last_run_time` DATETIME COMMENT '最后执行时间',
  `timeout` BIGINT UNSIGNED DEFAULT 3600 COMMENT '超时时间（秒）',
  `retry_count` BIGINT UNSIGNED DEFAULT 3 COMMENT '重试次数',
  `is_enabled` BIGINT UNSIGNED DEFAULT 1 COMMENT '是否启用：0-禁用，1-启用',
  `tags` TEXT COMMENT '标签（JSON 数组字符串）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_task_id` (`task_id`),
  KEY `idx_task_type` (`task_type`),
  KEY `idx_status` (`status`),
  KEY `idx_next_run_time` (`next_run_time`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_task_name` (`task_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='任务基础表';
```

#### 2.1.2 字段说明
| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | 任务 ID（主键） | 自增主键 |
| task_id | VARCHAR(36) | 任务唯一标识 | UUID |
| task_name | VARCHAR(255) | 任务名称 | 必填 |
| task_description | TEXT | 任务描述 | 可选 |
| task_type | VARCHAR(50) | 任务类型 | stock_selection/batch_backtest/single_backtest |
| status | VARCHAR(50) | 任务状态 | pending/running/completed/failed/cancelled |
| priority | BIGINT UNSIGNED | 任务优先级 | 1-10，默认5 |
| created_by | VARCHAR(36) | 创建用户 ID | 可选 |
| created_at | DATETIME | 创建时间 | 自动生成 |
| updated_by | VARCHAR(36) | 最后修改用户 ID | 可选 |
| updated_at | DATETIME | 最后修改时间 | 自动更新 |
| last_run_time | DATETIME | 最后执行时间 | 记录上次执行时间 |
| timeout | BIGINT UNSIGNED | 超时时间（秒） | 默认3600秒 |
| retry_count | BIGINT UNSIGNED | 重试次数 | 默认3次 |
| is_enabled | BIGINT UNSIGNED | 是否启用 | 0-禁用，1-启用 |
| tags | TEXT | 标签 | JSON 数组字符串 |

---

### 2.2 任务配置表（task_configs）

#### 2.2.1 表结构
```sql
CREATE TABLE `task_configs` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '配置 ID（主键）',
  `task_id` VARCHAR(36) NOT NULL COMMENT '任务 ID（外键）',
  `config_key` VARCHAR(100) NOT NULL COMMENT '配置键',
  `config_value` TEXT NOT NULL COMMENT '配置值（JSON 格式字符串）',
  `config_type` VARCHAR(50) NOT NULL COMMENT '配置类型',
  `version` BIGINT UNSIGNED DEFAULT 1 COMMENT '配置版本',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_task_id` (`task_id`),
  KEY `idx_config_key` (`config_key`),
  KEY `idx_config_type` (`config_type`),
  KEY `idx_version` (`version`),
  CONSTRAINT `fk_task_configs_task_id` FOREIGN KEY (`task_id`) REFERENCES `tasks` (`task_id`) ON DELETE CASCADE COMMENT '关联 tasks 表的 task_id 字段'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='任务配置表';
```

#### 2.2.2 字段说明
| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | 配置 ID（主键） | 自增主键 |
| task_id | VARCHAR(36) | 任务 ID（外键） | 关联 tasks 表 |
| config_key | VARCHAR(100) | 配置键 | 配置项的键名 |
| config_value | TEXT | 配置值 | JSON 格式字符串存储 |
| config_type | VARCHAR(50) | 配置类型 | 策略配置/参数配置/数据源配置等 |
| version | BIGINT UNSIGNED | 配置版本 | 支持配置版本管理 |
| created_at | DATETIME | 创建时间 | 自动生成 |
| updated_at | DATETIME | 更新时间 | 自动更新 |

---

### 2.3 任务执行记录表（task_executions）

#### 2.3.1 表结构
```sql
CREATE TABLE `task_executions` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '执行记录 ID（主键）',
  `execution_id` VARCHAR(36) NOT NULL COMMENT '执行唯一标识（UUID）',
  `task_id` VARCHAR(36) NOT NULL COMMENT '任务 ID（外键）',
  `status` VARCHAR(50) DEFAULT 'pending' COMMENT '执行状态：pending-待执行，running-执行中，completed-已完成，failed-失败，cancelled-已取消',
  `progress` BIGINT UNSIGNED DEFAULT 0 COMMENT '执行进度（0-100）',
  `current_stage` VARCHAR(100) COMMENT '当前执行阶段',
  `started_at` DATETIME COMMENT '开始执行时间',
  `finished_at` DATETIME COMMENT '完成时间',
  `duration` BIGINT UNSIGNED COMMENT '执行耗时（秒）',
  `error_message` TEXT COMMENT '错误信息',
  `result_file_path` VARCHAR(500) COMMENT '结果文件路径',
  `result_size` BIGINT UNSIGNED COMMENT '结果数据大小（字节）',
  `created_by` VARCHAR(36) COMMENT '触发用户 ID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_execution_id` (`execution_id`),
  KEY `idx_task_id` (`task_id`),
  KEY `idx_status` (`status`),
  KEY `idx_started_at` (`started_at`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_task_executions_task_id` FOREIGN KEY (`task_id`) REFERENCES `tasks` (`task_id`) ON DELETE CASCADE COMMENT '关联 tasks 表的 task_id 字段'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='任务执行记录表';
```

#### 2.3.2 字段说明
| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | 执行记录 ID（主键） | 自增主键 |
| execution_id | VARCHAR(36) | 执行唯一标识 | UUID |
| task_id | VARCHAR(36) | 任务 ID（外键） | 关联 tasks 表 |
| status | VARCHAR(50) | 执行状态 | pending/running/completed/failed/cancelled |
| progress | BIGINT UNSIGNED | 执行进度 | 0-100 |
| current_stage | VARCHAR(100) | 当前执行阶段 | 描述当前执行阶段 |
| started_at | DATETIME | 开始执行时间 | 任务开始时间 |
| finished_at | DATETIME | 完成时间 | 任务完成时间 |
| duration | BIGINT UNSIGNED | 执行耗时（秒） | 实际执行时间 |
| error_message | TEXT | 错误信息 | 失败时的错误信息 |
| result_file_path | VARCHAR(500) | 结果文件路径 | 结果文件存储路径 |
| result_size | BIGINT UNSIGNED | 结果数据大小（字节） | 结果文件大小 |
| created_by | VARCHAR(36) | 触发用户 ID | 手动触发时的用户 |
| created_at | DATETIME | 创建时间 | 自动生成 |

---

### 2.4 任务执行日志表（task_logs）

#### 2.4.1 表结构
```sql
CREATE TABLE `task_logs` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '日志 ID（主键）',
  `execution_id` VARCHAR(36) NOT NULL COMMENT '执行记录 ID（外键）',
  `log_level` VARCHAR(50) DEFAULT 'INFO' COMMENT '日志级别：DEBUG-调试信息，INFO-一般信息，WARNING-警告信息，ERROR-错误信息',
  `log_message` TEXT NOT NULL COMMENT '日志消息',
  `log_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '日志时间',
  `log_source` VARCHAR(100) COMMENT '日志来源',
  `extra_data` TEXT COMMENT '额外数据（JSON 格式字符串）',
  PRIMARY KEY (`id`),
  KEY `idx_execution_id` (`execution_id`),
  KEY `idx_log_level` (`log_level`),
  KEY `idx_log_time` (`log_time`),
  CONSTRAINT `fk_task_logs_execution_id` FOREIGN KEY (`execution_id`) REFERENCES `task_executions` (`execution_id`) ON DELETE CASCADE COMMENT '关联 task_executions 表的 execution_id 字段'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='任务执行日志表';
-- PARTITION BY RANGE (TO_DAYS(log_time)) (
--   PARTITION p202401 VALUES LESS THAN (TO_DAYS('2024-02-01')),
--   PARTITION p202402 VALUES LESS THAN (TO_DAYS('2024-03-01')),
--   PARTITION p202403 VALUES LESS THAN (TO_DAYS('2024-04-01')),
--   PARTITION p202404 VALUES LESS THAN (TO_DAYS('2024-05-01')),
--   PARTITION p202405 VALUES LESS THAN (TO_DAYS('2024-06-01')),
--   PARTITION p202406 VALUES LESS THAN (TO_DAYS('2024-07-01')),
--   PARTITION p202407 VALUES LESS THAN (TO_DAYS('2024-08-01')),
--   PARTITION p202408 VALUES LESS THAN (TO_DAYS('2024-09-01')),
--   PARTITION p202409 VALUES LESS THAN (TO_DAYS('2024-10-01')),
--   PARTITION p202410 VALUES LESS THAN (TO_DAYS('2024-11-01')),
--   PARTITION p202411 VALUES LESS THAN (TO_DAYS('2024-12-01')),
--   PARTITION p202412 VALUES LESS THAN (TO_DAYS('2025-01-01')),
--   PARTITION pmax VALUES LESS THAN MAXVALUE
-- );
```

#### 2.4.2 字段说明
| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | 日志 ID（主键） | 自增主键 |
| execution_id | VARCHAR(36) | 执行记录 ID（外键） | 关联 task_executions 表 |
| log_level | VARCHAR(50) | 日志级别 | DEBUG/INFO/WARNING/ERROR |
| log_message | TEXT | 日志消息 | 日志内容 |
| log_time | DATETIME | 日志时间 | 自动生成 |
| log_source | VARCHAR(100) | 日志来源 | 任务名称/模块名称等 |
| extra_data | TEXT | 额外数据 | JSON 格式字符串 |

#### 2.4.3 分区策略
-- - **分区类型**：RANGE 分区
-- - **分区键**：log_time
-- - **分区粒度**：按月分区
-- - **保留策略**：保留最近 12 个月数据

---

### 2.5 选股任务结果表（stock_selection_results）

#### 2.5.1 表结构
```sql
CREATE TABLE `stock_selection_results` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '结果 ID（主键）',
  `execution_id` VARCHAR(36) NOT NULL COMMENT '执行记录 ID（外键）',
  `stock_code` VARCHAR(10) NOT NULL COMMENT '股票代码',
  `stock_name` VARCHAR(100) COMMENT '股票名称',
  `match_score` DECIMAL(10,4) COMMENT '匹配度（0-100）',
  `match_reasons` TEXT COMMENT '匹配原因（JSON 数组字符串）',
  `selection_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '选股时间',
  `extra_data` TEXT COMMENT '额外数据（JSON 格式字符串）',
  PRIMARY KEY (`id`),
  KEY `idx_execution_id` (`execution_id`),
  KEY `idx_stock_code` (`stock_code`),
  KEY `idx_match_score` (`match_score`),
  KEY `idx_selection_time` (`selection_time`),
  CONSTRAINT `fk_stock_selection_results_execution_id` FOREIGN KEY (`execution_id`) REFERENCES `task_executions` (`execution_id`) ON DELETE CASCADE COMMENT '关联 task_executions 表的 execution_id 字段'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='选股任务结果表';
```

#### 2.5.2 字段说明
| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | 结果 ID（主键） | 自增主键 |
| execution_id | VARCHAR(36) | 执行记录 ID（外键） | 关联 task_executions 表 |
| stock_code | VARCHAR(10) | 股票代码 | 必填 |
| stock_name | VARCHAR(100) | 股票名称 | 可选 |
| match_score | DECIMAL(10,4) | 匹配度 | 0-100 |
| match_reasons | TEXT | 匹配原因 | JSON 数组字符串格式 |
| selection_time | DATETIME | 选股时间 | 自动生成 |
| extra_data | TEXT | 额外数据 | 技术指标值等（JSON 格式字符串） |

---

### 2.6 批量回测任务结果表（backtest_results）

#### 2.6.1 表结构
```sql
CREATE TABLE `backtest_results` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '结果 ID（主键）',
  `execution_id` VARCHAR(36) NOT NULL COMMENT '执行记录 ID（外键）',
  `stock_code` VARCHAR(10) NOT NULL COMMENT '股票代码',
  `stock_name` VARCHAR(100) COMMENT '股票名称',
  `total_return` DECIMAL(10,4) COMMENT '总收益率',
  `annual_return` DECIMAL(10,4) COMMENT '年化收益率',
  `sharpe_ratio` DECIMAL(10,4) COMMENT '夏普比率',
  `max_drawdown` DECIMAL(10,4) COMMENT '最大回撤',
  `win_rate` DECIMAL(10,4) COMMENT '胜率',
  `profit_loss_ratio` DECIMAL(10,4) COMMENT '盈亏比',
  `total_trades` BIGINT UNSIGNED COMMENT '总交易次数',
  `winning_trades` BIGINT UNSIGNED COMMENT '盈利交易次数',
  `losing_trades` BIGINT UNSIGNED COMMENT '亏损交易次数',
  `backtest_start_date` DATETIME COMMENT '回测开始日期',
  `backtest_end_date` DATETIME COMMENT '回测结束日期',
  `extra_data` TEXT COMMENT '额外数据（JSON 格式字符串）',
  PRIMARY KEY (`id`),
  KEY `idx_execution_id` (`execution_id`),
  KEY `idx_stock_code` (`stock_code`),
  KEY `idx_total_return` (`total_return`),
  KEY `idx_win_rate` (`win_rate`),
  CONSTRAINT `fk_backtest_results_execution_id` FOREIGN KEY (`execution_id`) REFERENCES `task_executions` (`execution_id`) ON DELETE CASCADE COMMENT '关联 task_executions 表的 execution_id 字段'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='批量回测任务结果表';
```

#### 2.6.2 字段说明
| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | 结果 ID（主键） | 自增主键 |
| execution_id | VARCHAR(36) | 执行记录 ID（外键） | 关联 task_executions 表 |
| stock_code | VARCHAR(10) | 股票代码 | 必填 |
| stock_name | VARCHAR(100) | 股票名称 | 可选 |
| total_return | DECIMAL(10,4) | 总收益率 | 百分比 |
| annual_return | DECIMAL(10,4) | 年化收益率 | 百分比 |
| sharpe_ratio | DECIMAL(10,4) | 夏普比率 | 风险调整后收益 |
| max_drawdown | DECIMAL(10,4) | 最大回撤 | 百分比 |
| win_rate | DECIMAL(10,4) | 胜率 | 百分比 |
| profit_loss_ratio | DECIMAL(10,4) | 盈亏比 | 盈利/亏损比 |
| total_trades | BIGINT UNSIGNED | 总交易次数 | 交易总次数 |
| winning_trades | BIGINT UNSIGNED | 盈利交易次数 | 盈利交易数 |
| losing_trades | BIGINT UNSIGNED | 亏损交易次数 | 亏损交易数 |
| backtest_start_date | DATETIME | 回测开始日期 | 回测起始日期 |
| backtest_end_date | DATETIME | 回测结束日期 | 回测结束日期 |
| extra_data | TEXT | 额外数据 | 其他指标等（JSON 格式字符串） |

---

### 2.7 交易明细表（trade_details）

#### 2.7.1 表结构
```sql
CREATE TABLE `trade_details` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '交易 ID（主键）',
  `result_id` BIGINT UNSIGNED NOT NULL COMMENT '回测结果 ID（外键）',
  `stock_code` VARCHAR(10) NOT NULL COMMENT '股票代码',
  `trade_type` VARCHAR(50) NOT NULL COMMENT '交易类型：buy-买入，sell-卖出',
  `trade_date` DATETIME NOT NULL COMMENT '交易日期',
  `trade_price` DECIMAL(10,2) NOT NULL COMMENT '交易价格',
  `trade_quantity` BIGINT UNSIGNED NOT NULL COMMENT '交易数量',
  `trade_amount` DECIMAL(15,2) NOT NULL COMMENT '交易金额',
  `profit_loss` DECIMAL(15,2) COMMENT '盈亏金额',
  `profit_loss_rate` DECIMAL(10,4) COMMENT '盈亏比例',
  `trade_reason` VARCHAR(500) COMMENT '交易原因',
  `extra_data` TEXT COMMENT '额外数据（JSON 格式字符串）',
  PRIMARY KEY (`id`),
  KEY `idx_result_id` (`result_id`),
  KEY `idx_stock_code` (`stock_code`),
  KEY `idx_trade_date` (`trade_date`),
  KEY `idx_trade_type` (`trade_type`),
  CONSTRAINT `fk_trade_details_result_id` FOREIGN KEY (`result_id`) REFERENCES `backtest_results` (`id`) ON DELETE CASCADE COMMENT '关联 backtest_results 表的 id 字段'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='交易明细表';
-- PARTITION BY RANGE (TO_DAYS(trade_date)) (
--   PARTITION p2020 VALUES LESS THAN (TO_DAYS('2021-01-01')),
--   PARTITION p2021 VALUES LESS THAN (TO_DAYS('2022-01-01')),
--   PARTITION p2022 VALUES LESS THAN (TO_DAYS('2023-01-01')),
--   PARTITION p2023 VALUES LESS THAN (TO_DAYS('2024-01-01')),
--   PARTITION p2024 VALUES LESS THAN (TO_DAYS('2025-01-01')),
--   PARTITION p2025 VALUES LESS THAN (TO_DAYS('2026-01-01')),
--   PARTITION p2026 VALUES LESS THAN (TO_DAYS('2027-01-01')),
--   PARTITION p2027 VALUES LESS THAN (TO_DAYS('2028-01-01')),
--   PARTITION p2028 VALUES LESS THAN (TO_DAYS('2029-01-01')),
--   PARTITION pmax VALUES LESS THAN MAXVALUE
-- );
```

#### 2.7.2 字段说明
| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | 交易 ID（主键） | 自增主键 |
| result_id | BIGINT UNSIGNED | 回测结果 ID（外键） | 关联 backtest_results 表 |
| stock_code | VARCHAR(10) | 股票代码 | 必填 |
| trade_type | VARCHAR(50) | 交易类型 | buy/sell |
| trade_date | DATETIME | 交易日期 | 必填 |
| trade_price | DECIMAL(10,2) | 交易价格 | 必填 |
| trade_quantity | BIGINT UNSIGNED | 交易数量 | 必填 |
| trade_amount | DECIMAL(15,2) | 交易金额 | 必填 |
| profit_loss | DECIMAL(15,2) | 盈亏金额 | 卖出时计算 |
| profit_loss_rate | DECIMAL(10,4) | 盈亏比例 | 百分比 |
| trade_reason | VARCHAR(500) | 交易原因 | 交易触发原因 |
| extra_data | TEXT | 额外数据 | 其他信息（JSON 格式字符串） |

#### 2.7.3 分区策略
-- - **分区类型**：RANGE 分区
-- - **分区键**：trade_date
-- - **分区粒度**：按年分区
-- - **保留策略**：保留最近 5 年数据

---

### 2.8 任务依赖表（task_dependencies）

#### 2.8.1 表结构
```sql
CREATE TABLE `task_dependencies` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '依赖 ID（主键）',
  `task_id` VARCHAR(36) NOT NULL COMMENT '任务 ID（外键）',
  `depends_on_task_id` VARCHAR(36) NOT NULL COMMENT '依赖的任务 ID（外键）',
  `dependency_type` VARCHAR(50) NOT NULL COMMENT '依赖类型：predecessor-前置任务，successor-后置任务',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_task_dependency` (`task_id`, `depends_on_task_id`, `dependency_type`),
  KEY `idx_task_id` (`task_id`),
  KEY `idx_depends_on_task_id` (`depends_on_task_id`),
  CONSTRAINT `fk_task_dependencies_task_id` FOREIGN KEY (`task_id`) REFERENCES `tasks` (`task_id`) ON DELETE CASCADE COMMENT '关联 tasks 表的 task_id 字段',
  CONSTRAINT `fk_task_dependencies_depends_on_task_id` FOREIGN KEY (`depends_on_task_id`) REFERENCES `tasks` (`task_id`) ON DELETE CASCADE COMMENT '关联 tasks 表的 task_id 字段'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='任务依赖表';
```

#### 2.8.2 字段说明
| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | 依赖 ID（主键） | 自增主键 |
| task_id | VARCHAR(36) | 任务 ID（外键） | 关联 tasks 表 |
| depends_on_task_id | VARCHAR(36) | 依赖的任务 ID（外键） | 关联 tasks 表 |
| dependency_type | VARCHAR(50) | 依赖类型 | predecessor/successor |
| created_at | DATETIME | 创建时间 | 自动生成 |

---

### 2.9 任务模板表（task_templates）

#### 2.9.1 表结构
```sql
CREATE TABLE `task_templates` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '模板 ID（主键）',
  `template_id` VARCHAR(36) NOT NULL COMMENT '模板唯一标识（UUID）',
  `template_name` VARCHAR(255) NOT NULL COMMENT '模板名称',
  `template_description` TEXT COMMENT '模板描述',
  `template_type` VARCHAR(50) NOT NULL COMMENT '模板类型：stock_selection-选股模板，batch_backtest-批量回测模板，single_backtest-个股回测模板',
  `template_config` TEXT NOT NULL COMMENT '模板配置（JSON 格式字符串）',
  `is_public` BIGINT UNSIGNED DEFAULT 0 COMMENT '是否公开：0-私有，1-公开',
  `created_by` VARCHAR(36) COMMENT '创建用户 ID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_template_id` (`template_id`),
  KEY `idx_template_type` (`template_type`),
  KEY `idx_is_public` (`is_public`),
  KEY `idx_created_by` (`created_by`),
  KEY `idx_template_name` (`template_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='任务模板表';
```

#### 2.9.2 字段说明
| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | 模板 ID（主键） | 自增主键 |
| template_id | VARCHAR(36) | 模板唯一标识 | UUID |
| template_name | VARCHAR(255) | 模板名称 | 必填 |
| template_description | TEXT | 模板描述 | 可选 |
| template_type | VARCHAR(50) | 模板类型 | stock_selection/batch_backtest/single_backtest |
| template_config | TEXT | 模板配置 | JSON 格式字符串 |
| is_public | BIGINT UNSIGNED | 是否公开 | 0-私有，1-公开 |
| created_by | VARCHAR(36) | 创建用户 ID | 可选 |
| created_at | DATETIME | 创建时间 | 自动生成 |
| updated_at | DATETIME | 更新时间 | 自动更新 |

---

## 3. 表关系图（ER图）

### 3.1 实体关系说明

```
┌─────────────────┐
│   tasks         │
│   (任务基础表)   │
└────────┬────────┘
         │
         │ 1:N
         │
    ┌────┴────┐
    │         │
    │         │
    ▼         ▼
┌─────────┐  ┌─────────────┐
│task_    │  │task_        │
│configs  │  │dependencies │
│(任务配置)│  │(任务依赖)   │
└─────────┘  └─────────────┘
                  │
                  │ N:M
                  │
            ┌─────┴─────┐
            │           │
            │           │
            ▼           ▼
      ┌─────────┐  ┌─────────┐
      │tasks    │  │tasks    │
      └─────────┘  └─────────┘

┌─────────────────┐
│   tasks         │
│   (任务基础表)   │
└────────┬────────┘
         │
         │ 1:N
         │
         ▼
┌─────────────────┐
│task_executions  │
│(任务执行记录)   │
└────────┬────────┘
         │
         │ 1:N
         │
    ┌────┴────┐
    │         │
    │         │
    ▼         ▼
┌─────────┐  ┌─────────┐
│task_    │  │stock_   │
│logs     │  │selection│
│(执行日志)│  │_results │
└─────────┘  │(选股结果)│
             └─────────┘

┌─────────────────┐
│task_executions  │
│(任务执行记录)   │
└────────┬────────┘
         │
         │ 1:N
         │
         ▼
┌─────────────────┐
│backtest_       │
│results         │
│(回测结果)       │
└────────┬────────┘
         │
         │ 1:N
         │
         ▼
┌─────────────────┐
│trade_details   │
│(交易明细)       │
└─────────────────┘

┌─────────────────┐
│task_templates  │
│(任务模板)       │
└─────────────────┘
```

### 3.2 完整 ER 图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              股票交易系统数据库 ER 图                            │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  tasks (任务基础表)                                                            │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ PK  id                 BIGINT UNSIGNED                                  │   │
│  │ UK  task_id            VARCHAR(36)                                     │   │
│  │     task_name          VARCHAR(255)                                     │   │
│  │     task_description   TEXT                                            │   │
│  │     task_type          VARCHAR(50)                                     │   │
│  │     status             VARCHAR(50)                                     │   │
│  │     priority           BIGINT UNSIGNED                                 │   │
│  │     created_by         VARCHAR(36)                                     │   │
│  │     created_at         DATETIME                                        │   │
│  │     updated_by         VARCHAR(36)                                     │   │
│  │     updated_at         DATETIME                                        │   │
│  │     last_run_time      DATETIME                                        │   │
│  │     timeout            BIGINT UNSIGNED                                     │   │
│  │     retry_count        BIGINT UNSIGNED                                 │   │
│  │     is_enabled         BIGINT UNSIGNED                                     │   │
│  │     tags               TEXT                                            │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
         │
         │ 1:N
         │
         ├──────────────────────────────────────────────────────────────────────┐
         │                                                                      │
         │                                                                      │
         ▼                                                                      ▼
┌─────────────────────────────────────────┐    ┌─────────────────────────────────────────┐
│  task_configs (任务配置表)              │    │  task_executions (任务执行记录表)        │
│  ┌─────────────────────────────────┐   │    │  ┌─────────────────────────────────┐   │
│  │ PK  id                 BIGINT  │   │    │  │ PK  id                 BIGINT  │   │
│  │ FK  task_id            VARCHAR │   │    │  │ UK  execution_id       VARCHAR │   │
│  │     config_key         VARCHAR │   │    │  │ FK  task_id            VARCHAR │   │
│  │     config_value       TEXT    │   │    │  │     status             VARCHAR │   │
│  │     config_type        VARCHAR │   │    │  │     progress           BIGINT  │   │
│  │     version            BIGINT  │   │    │  │     current_stage      VARCHAR │   │
│  │     created_at         DATETIME│   │    │  │     started_at         DATETIME│   │
│  │     updated_at         DATETIME│   │    │  │     finished_at        DATETIME│   │
│  └─────────────────────────────────┘   │    │  │     duration           BIGINT  │   │
└─────────────────────────────────────────┘    │  │     error_message      TEXT    │
                                              │  │     result_file_path   VARCHAR │
                                              │  │     result_size        BIGINT  │
                                              │  │     created_by         VARCHAR │
                                              │  │     created_at         DATETIME│
                                              │  └─────────────────────────────────┘   │
                                              └─────────────────────────────────────────┘
                                                                                     │
                                                                                     │ 1:N
                                                                                     │
                                                    ┌────────────────────────────────┴────────┐
                                                    │                                 │
                                                    │                                 │
                                                    ▼                                 ▼
                                      ┌─────────────────────────┐    ┌─────────────────────────┐
                                      │  task_logs (执行日志)    │    │  stock_selection_      │
                                      │  ┌───────────────────┐   │    │  results (选股结果)    │
                                      │  │ PK  id    BIGINT │   │    │  ┌───────────────────┐   │
                                      │  │ FK  execution_id │   │    │  │ PK  id    BIGINT │   │
                                      │  │     log_level    │   │    │  │ FK  execution_id │   │
                                      │  │     log_message  │   │    │  │     stock_code   │   │
                                      │  │     log_time     │   │    │  │     stock_name   │   │
                                      │  │     log_source   │   │    │  │     match_score  │   │
                                      │  │     extra_data   │   │    │  │     match_reasons│   │
                                      │  └───────────────────┘   │    │  │     selection_time│   │
                                      └─────────────────────────┘    │  │     extra_data   │   │
                                      └─────────────────────────┘    │  │     extra_data   │   │
                                                                    └─────────────────────────┘
                                                                                     │
                                                                                     │ 1:N
                                                                                     │
                                                                                     ▼
                                                                      ┌─────────────────────────┐
                                                                      │  backtest_results       │
                                                                      │  (回测结果)              │
                                                                      │  ┌───────────────────┐   │
                                                                      │  │ PK  id    BIGINT │   │
                                                                      │  │ FK  execution_id │   │
                                                                      │  │     stock_code   │   │
                                                                      │  │     stock_name   │   │
                                                                      │  │     total_return │   │
                                                                      │  │     annual_return│   │
                                                                      │  │     sharpe_ratio │   │
                                                                      │  │     max_drawdown │   │
                                                                      │  │     win_rate     │   │
                                                                      │  │     profit_loss_ │   │
                                                                      │  │     ratio        │   │
                                                                      │  │     total_trades │   │
                                                                      │  │     winning_     │   │
                                                                      │  │     trades       │   │
                                                                      │  │     losing_      │   │
                                                                      │  │     trades       │   │
                                                                      │  │     backtest_    │   │
                                                                      │  │     start_date   │   │
                                                                      │  │     backtest_    │   │
                                                                      │  │     end_date     │   │
                                                                      │  │     extra_data   │   │
                                                                      │  └───────────────────┘   │
                                                                      └─────────────────────────┘
                                                                                     │
                                                                                     │ 1:N
                                                                                     │
                                                                                     ▼
                                                                      ┌─────────────────────────┐
                                                                      │  trade_details          │
                                                                      │  (交易明细)              │
                                                                      │  ┌───────────────────┐   │
                                                                      │  │ PK  id    BIGINT │   │
                                                                      │  │ FK  result_id    │   │
                                                                      │  │     stock_code   │   │
                                                                      │  │     trade_type   │   │
                                                                      │  │     trade_date   │   │
                                                                      │  │     trade_price  │   │
                                                                      │  │     trade_       │   │
                                                                      │  │     quantity     │   │
                                                                      │  │     trade_amount │   │
                                                                      │  │     profit_loss  │   │
                                                                      │  │     profit_loss_ │   │
                                                                      │  │     rate         │   │
                                                                      │  │     trade_reason │   │
                                                                      │  │     extra_data   │   │
                                                                      │  └───────────────────┘   │
                                                                      └─────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  task_dependencies (任务依赖表)                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ PK  id                 BIGINT UNSIGNED                                  │   │
│  │ FK  task_id            VARCHAR(36)                                     │   │
│  │ FK  depends_on_task_id VARCHAR(36)                                     │   │
│  │     dependency_type    VARCHAR(50)                                     │   │
│  │     created_at         DATETIME                                        │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
         │
         │ N:M
         │
         ▼
┌─────────────────────────────────────────┐
│  tasks (任务基础表)                    │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  task_templates (任务模板表)                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ PK  id                 BIGINT UNSIGNED                                  │   │
│  │ UK  template_id        VARCHAR(36)                                     │   │
│  │     template_name      VARCHAR(255)                                     │   │
│  │     template_description TEXT                                            │   │
│  │     template_type      VARCHAR(50)                                     │   │
│  │     template_config    TEXT                                            │   │
│  │     is_public          BIGINT UNSIGNED                                     │   │
│  │     created_by         VARCHAR(36)                                     │   │
│  │     created_at         DATETIME                                        │   │
│  │     updated_at         DATETIME                                        │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 表关系说明

#### 3.3.1 核心关系
1. **tasks → task_configs** (1:N)
   - 一个任务可以有多个配置项
   - 配置项支持版本管理

2. **tasks → task_executions** (1:N)
   - 一个任务可以执行多次
   - 每次执行产生一条执行记录

3. **task_executions → task_logs** (1:N)
   - 一次执行可以产生多条日志
   - 日志按月分区存储

4. **task_executions → stock_selection_results** (1:N)
   - 一次选股任务执行可以产生多个选股结果

5. **task_executions → backtest_results** (1:N)
   - 一次批量回测任务执行可以产生多个回测结果

6. **backtest_results → trade_details** (1:N)
   - 一个回测结果可以包含多条交易明细
   - 交易明细按年分区存储

7. **tasks → task_dependencies** (N:M)
   - 任务之间可以有多对多的依赖关系
   - 支持前置任务和后置任务

8. **task_templates** (独立表)
   - 任务模板独立存储
   - 可以基于模板创建任务

#### 3.3.2 级联删除规则
- 删除任务时，级联删除：
  - 任务配置 (task_configs)
  - 任务执行记录 (task_executions)
  - 任务依赖关系 (task_dependencies)
- 删除执行记录时，级联删除：
  - 执行日志 (task_logs)
  - 选股结果 (stock_selection_results)
  - 回测结果 (backtest_results)
- 删除回测结果时，级联删除：
  - 交易明细 (trade_details)

---

## 4. 索引设计

### 4.1 索引汇总表

| 表名 | 索引名 | 索引类型 | 索引字段 | 说明 |
|------|--------|----------|----------|------|
| tasks | PRIMARY | 主键索引 | id | 主键 |
| tasks | uk_task_id | 唯一索引 | task_id | 任务唯一标识 |
| tasks | idx_task_type | 普通索引 | task_type | 按任务类型查询 |
| tasks | idx_status | 普通索引 | status | 按状态查询 |
| tasks | idx_created_at | 普通索引 | created_at | 按创建时间查询 |
| tasks | idx_task_name | 普通索引 | task_name | 按任务名称查询 |
| task_configs | PRIMARY | 主键索引 | id | 主键 |
| task_configs | idx_task_id | 普通索引 | task_id | 按任务ID查询 |
| task_configs | idx_config_key | 普通索引 | config_key | 按配置键查询 |
| task_configs | idx_config_type | 普通索引 | config_type | 按配置类型查询 |
| task_configs | idx_version | 普通索引 | version | 按版本查询 |
| task_executions | PRIMARY | 主键索引 | id | 主键 |
| task_executions | uk_execution_id | 唯一索引 | execution_id | 执行记录唯一标识 |
| task_executions | idx_task_id | 普通索引 | task_id | 按任务ID查询 |
| task_executions | idx_status | 普通索引 | status | 按状态查询 |
| task_executions | idx_started_at | 普通索引 | started_at | 按开始时间查询 |
| task_executions | idx_created_at | 普通索引 | created_at | 按创建时间查询 |
| task_logs | PRIMARY | 主键索引 | id | 主键 |
| task_logs | idx_execution_id | 普通索引 | execution_id | 按执行记录ID查询 |
| task_logs | idx_log_level | 普通索引 | log_level | 按日志级别查询 |
| task_logs | idx_log_time | 普通索引 | log_time | 按日志时间查询 |
| stock_selection_results | PRIMARY | 主键索引 | id | 主键 |
| stock_selection_results | idx_execution_id | 普通索引 | execution_id | 按执行记录ID查询 |
| stock_selection_results | idx_stock_code | 普通索引 | stock_code | 按股票代码查询 |
| stock_selection_results | idx_match_score | 普通索引 | match_score | 按匹配度查询 |
| stock_selection_results | idx_selection_time | 普通索引 | selection_time | 按选股时间查询 |
| backtest_results | PRIMARY | 主键索引 | id | 主键 |
| backtest_results | idx_execution_id | 普通索引 | execution_id | 按执行记录ID查询 |
| backtest_results | idx_stock_code | 普通索引 | stock_code | 按股票代码查询 |
| backtest_results | idx_total_return | 普通索引 | total_return | 按总收益率查询 |
| backtest_results | idx_win_rate | 普通索引 | win_rate | 按胜率查询 |
| trade_details | PRIMARY | 主键索引 | id | 主键 |
| trade_details | idx_result_id | 普通索引 | result_id | 按回测结果ID查询 |
| trade_details | idx_stock_code | 普通索引 | stock_code | 按股票代码查询 |
| trade_details | idx_trade_date | 普通索引 | trade_date | 按交易日期查询 |
| trade_details | idx_trade_type | 普通索引 | trade_type | 按交易类型查询 |
| task_dependencies | PRIMARY | 主键索引 | id | 主键 |
| task_dependencies | uk_task_dependency | 唯一索引 | task_id, depends_on_task_id, dependency_type | 防止重复依赖 |
| task_dependencies | idx_task_id | 普通索引 | task_id | 按任务ID查询 |
| task_dependencies | idx_depends_on_task_id | 普通索引 | depends_on_task_id | 按依赖任务ID查询 |
| task_templates | PRIMARY | 主键索引 | id | 主键 |
| task_templates | uk_template_id | 唯一索引 | template_id | 模板唯一标识 |
| task_templates | idx_template_type | 普通索引 | template_type | 按模板类型查询 |
| task_templates | idx_is_public | 普通索引 | is_public | 按是否公开查询 |
| task_templates | idx_created_by | 普通索引 | created_by | 按创建用户查询 |
| task_templates | idx_template_name | 普通索引 | template_name | 按模板名称查询 |

### 4.2 索引优化建议
1. **高频查询字段**：为经常作为查询条件的字段建立索引
2. **外键字段**：所有外键字段都建立索引
3. **排序字段**：为经常排序的字段建立索引
4. **联合索引**：对于多字段查询，考虑建立联合索引
5. **索引监控**：定期监控索引使用情况，删除未使用的索引

---

## 5. 数据库初始化脚本

### 5.1 完整初始化脚本

```sql
-- 股票交易系统数据库初始化脚本
-- 版本：1.0
-- 日期：2024-01-01

-- 创建数据库
CREATE DATABASE IF NOT EXISTS `stock_trade_system` 
DEFAULT CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

USE `stock_trade_system`;

-- 设置时区
SET time_zone = '+08:00';

-- 创建任务基础表
CREATE TABLE `tasks` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '任务 ID（主键）',
  `task_id` VARCHAR(36) NOT NULL COMMENT '任务唯一标识（UUID）',
  `task_name` VARCHAR(255) NOT NULL COMMENT '任务名称',
  `task_description` TEXT COMMENT '任务描述',
  `task_type` VARCHAR(50) NOT NULL COMMENT '任务类型：stock_selection-选股任务，batch_backtest-批量回测任务，single_backtest-个股回测任务',
  `status` VARCHAR(50) DEFAULT 'pending' COMMENT '任务状态：pending-待执行，running-执行中，completed-已完成，failed-失败，cancelled-已取消',
  `priority` BIGINT UNSIGNED DEFAULT 5 COMMENT '任务优先级（1-10）',
  `created_by` VARCHAR(36) COMMENT '创建用户 ID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_by` VARCHAR(36) COMMENT '最后修改用户 ID',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后修改时间',
  `last_run_time` DATETIME COMMENT '最后执行时间',
  `timeout` BIGINT UNSIGNED DEFAULT 3600 COMMENT '超时时间（秒）',
  `retry_count` BIGINT UNSIGNED DEFAULT 3 COMMENT '重试次数',
  `is_enabled` BIGINT UNSIGNED DEFAULT 1 COMMENT '是否启用：0-禁用，1-启用',
  `tags` TEXT COMMENT '标签（JSON 数组字符串）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_task_id` (`task_id`),
  KEY `idx_task_type` (`task_type`),
  KEY `idx_status` (`status`),
  KEY `idx_next_run_time` (`next_run_time`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_task_name` (`task_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='任务基础表';

-- 创建任务配置表
CREATE TABLE `task_configs` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '配置 ID（主键）',
  `task_id` VARCHAR(36) NOT NULL COMMENT '任务 ID（外键）',
  `config_key` VARCHAR(100) NOT NULL COMMENT '配置键',
  `config_value` TEXT NOT NULL COMMENT '配置值（JSON 格式字符串）',
  `config_type` VARCHAR(50) NOT NULL COMMENT '配置类型',
  `version` BIGINT UNSIGNED DEFAULT 1 COMMENT '配置版本',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_task_id` (`task_id`),
  KEY `idx_config_key` (`config_key`),
  KEY `idx_config_type` (`config_type`),
  KEY `idx_version` (`version`),
  CONSTRAINT `fk_task_configs_task_id` FOREIGN KEY (`task_id`) REFERENCES `tasks` (`task_id`) ON DELETE CASCADE COMMENT '关联 tasks 表的 task_id 字段'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='任务配置表';

-- 创建任务执行记录表
CREATE TABLE `task_executions` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '执行记录 ID（主键）',
  `execution_id` VARCHAR(36) NOT NULL COMMENT '执行唯一标识（UUID）',
  `task_id` VARCHAR(36) NOT NULL COMMENT '任务 ID（外键）',
  `status` VARCHAR(50) DEFAULT 'pending' COMMENT '执行状态：pending-待执行，running-执行中，completed-已完成，failed-失败，cancelled-已取消',
  `progress` BIGINT UNSIGNED DEFAULT 0 COMMENT '执行进度（0-100）',
  `current_stage` VARCHAR(100) COMMENT '当前执行阶段',
  `started_at` DATETIME COMMENT '开始执行时间',
  `finished_at` DATETIME COMMENT '完成时间',
  `duration` BIGINT UNSIGNED COMMENT '执行耗时（秒）',
  `error_message` TEXT COMMENT '错误信息',
  `result_file_path` VARCHAR(500) COMMENT '结果文件路径',
  `result_size` BIGINT UNSIGNED COMMENT '结果数据大小（字节）',
  `created_by` VARCHAR(36) COMMENT '触发用户 ID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_execution_id` (`execution_id`),
  KEY `idx_task_id` (`task_id`),
  KEY `idx_status` (`status`),
  KEY `idx_started_at` (`started_at`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_task_executions_task_id` FOREIGN KEY (`task_id`) REFERENCES `tasks` (`task_id`) ON DELETE CASCADE COMMENT '关联 tasks 表的 task_id 字段'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='任务执行记录表';

-- 创建任务执行日志表
CREATE TABLE `task_logs` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '日志 ID（主键）',
  `execution_id` VARCHAR(36) NOT NULL COMMENT '执行记录 ID（外键）',
  `log_level` VARCHAR(50) DEFAULT 'INFO' COMMENT '日志级别：DEBUG-调试信息，INFO-一般信息，WARNING-警告信息，ERROR-错误信息',
  `log_message` TEXT NOT NULL COMMENT '日志消息',
  `log_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '日志时间',
  `log_source` VARCHAR(100) COMMENT '日志来源',
  `extra_data` TEXT COMMENT '额外数据（JSON 格式字符串）',
  PRIMARY KEY (`id`),
  KEY `idx_execution_id` (`execution_id`),
  KEY `idx_log_level` (`log_level`),
  KEY `idx_log_time` (`log_time`),
  CONSTRAINT `fk_task_logs_execution_id` FOREIGN KEY (`execution_id`) REFERENCES `task_executions` (`execution_id`) ON DELETE CASCADE COMMENT '关联 task_executions 表的 execution_id 字段'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='任务执行日志表';
-- PARTITION BY RANGE (TO_DAYS(log_time)) (
--   PARTITION p202401 VALUES LESS THAN (TO_DAYS('2024-02-01')),
--   PARTITION p202402 VALUES LESS THAN (TO_DAYS('2024-03-01')),
--   PARTITION p202403 VALUES LESS THAN (TO_DAYS('2024-04-01')),
--   PARTITION p202404 VALUES LESS THAN (TO_DAYS('2024-05-01')),
--   PARTITION p202405 VALUES LESS THAN (TO_DAYS('2024-06-01')),
--   PARTITION p202406 VALUES LESS THAN (TO_DAYS('2024-07-01')),
--   PARTITION p202407 VALUES LESS THAN (TO_DAYS('2024-08-01')),
--   PARTITION p202408 VALUES LESS THAN (TO_DAYS('2024-09-01')),
--   PARTITION p202409 VALUES LESS THAN (TO_DAYS('2024-10-01')),
--   PARTITION p202410 VALUES LESS THAN (TO_DAYS('2024-11-01')),
--   PARTITION p202411 VALUES LESS THAN (TO_DAYS('2024-12-01')),
--   PARTITION p202412 VALUES LESS THAN (TO_DAYS('2025-01-01')),
--   PARTITION pmax VALUES LESS THAN MAXVALUE
-- );

-- 创建选股任务结果表
CREATE TABLE `stock_selection_results` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '结果 ID（主键）',
  `execution_id` VARCHAR(36) NOT NULL COMMENT '执行记录 ID（外键）',
  `stock_code` VARCHAR(10) NOT NULL COMMENT '股票代码',
  `stock_name` VARCHAR(100) COMMENT '股票名称',
  `match_score` DECIMAL(10,4) COMMENT '匹配度（0-100）',
  `match_reasons` TEXT COMMENT '匹配原因（JSON 数组字符串）',
  `selection_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '选股时间',
  `extra_data` TEXT COMMENT '额外数据（JSON 格式字符串）',
  PRIMARY KEY (`id`),
  KEY `idx_execution_id` (`execution_id`),
  KEY `idx_stock_code` (`stock_code`),
  KEY `idx_match_score` (`match_score`),
  KEY `idx_selection_time` (`selection_time`),
  CONSTRAINT `fk_stock_selection_results_execution_id` FOREIGN KEY (`execution_id`) REFERENCES `task_executions` (`execution_id`) ON DELETE CASCADE COMMENT '关联 task_executions 表的 execution_id 字段'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='选股任务结果表';

-- 创建批量回测任务结果表
CREATE TABLE `backtest_results` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '结果 ID（主键）',
  `execution_id` VARCHAR(36) NOT NULL COMMENT '执行记录 ID（外键）',
  `stock_code` VARCHAR(10) NOT NULL COMMENT '股票代码',
  `stock_name` VARCHAR(100) COMMENT '股票名称',
  `total_return` DECIMAL(10,4) COMMENT '总收益率',
  `annual_return` DECIMAL(10,4) COMMENT '年化收益率',
  `sharpe_ratio` DECIMAL(10,4) COMMENT '夏普比率',
  `max_drawdown` DECIMAL(10,4) COMMENT '最大回撤',
  `win_rate` DECIMAL(10,4) COMMENT '胜率',
  `profit_loss_ratio` DECIMAL(10,4) COMMENT '盈亏比',
  `total_trades` BIGINT UNSIGNED COMMENT '总交易次数',
  `winning_trades` BIGINT UNSIGNED COMMENT '盈利交易次数',
  `losing_trades` BIGINT UNSIGNED COMMENT '亏损交易次数',
  `backtest_start_date` DATETIME COMMENT '回测开始日期',
  `backtest_end_date` DATETIME COMMENT '回测结束日期',
  `extra_data` TEXT COMMENT '额外数据（JSON 格式字符串）',
  PRIMARY KEY (`id`),
  KEY `idx_execution_id` (`execution_id`),
  KEY `idx_stock_code` (`stock_code`),
  KEY `idx_total_return` (`total_return`),
  KEY `idx_win_rate` (`win_rate`),
  CONSTRAINT `fk_backtest_results_execution_id` FOREIGN KEY (`execution_id`) REFERENCES `task_executions` (`execution_id`) ON DELETE CASCADE COMMENT '关联 task_executions 表的 execution_id 字段'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='批量回测任务结果表';

-- 创建交易明细表
CREATE TABLE `trade_details` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '交易 ID（主键）',
  `result_id` BIGINT UNSIGNED NOT NULL COMMENT '回测结果 ID（外键）',
  `stock_code` VARCHAR(10) NOT NULL COMMENT '股票代码',
  `trade_type` VARCHAR(50) NOT NULL COMMENT '交易类型：buy-买入，sell-卖出',
  `trade_date` DATETIME NOT NULL COMMENT '交易日期',
  `trade_price` DECIMAL(10,2) NOT NULL COMMENT '交易价格',
  `trade_quantity` BIGINT UNSIGNED NOT NULL COMMENT '交易数量',
  `trade_amount` DECIMAL(15,2) NOT NULL COMMENT '交易金额',
  `profit_loss` DECIMAL(15,2) COMMENT '盈亏金额',
  `profit_loss_rate` DECIMAL(10,4) COMMENT '盈亏比例',
  `trade_reason` VARCHAR(500) COMMENT '交易原因',
  `extra_data` TEXT COMMENT '额外数据（JSON 格式字符串）',
  PRIMARY KEY (`id`),
  KEY `idx_result_id` (`result_id`),
  KEY `idx_stock_code` (`stock_code`),
  KEY `idx_trade_date` (`trade_date`),
  KEY `idx_trade_type` (`trade_type`),
  CONSTRAINT `fk_trade_details_result_id` FOREIGN KEY (`result_id`) REFERENCES `backtest_results` (`id`) ON DELETE CASCADE COMMENT '关联 backtest_results 表的 id 字段'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='交易明细表';
-- PARTITION BY RANGE (TO_DAYS(trade_date)) (
--   PARTITION p2020 VALUES LESS THAN (TO_DAYS('2021-01-01')),
--   PARTITION p2021 VALUES LESS THAN (TO_DAYS('2022-01-01')),
--   PARTITION p2022 VALUES LESS THAN (TO_DAYS('2023-01-01')),
--   PARTITION p2023 VALUES LESS THAN (TO_DAYS('2024-01-01')),
--   PARTITION p2024 VALUES LESS THAN (TO_DAYS('2025-01-01')),
--   PARTITION p2025 VALUES LESS THAN (TO_DAYS('2026-01-01')),
--   PARTITION p2026 VALUES LESS THAN (TO_DAYS('2027-01-01')),
--   PARTITION p2027 VALUES LESS THAN (TO_DAYS('2028-01-01')),
--   PARTITION p2028 VALUES LESS THAN (TO_DAYS('2029-01-01')),
--   PARTITION pmax VALUES LESS THAN MAXVALUE
-- );

-- 创建任务依赖表
CREATE TABLE `task_dependencies` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '依赖 ID（主键）',
  `task_id` VARCHAR(36) NOT NULL COMMENT '任务 ID（外键）',
  `depends_on_task_id` VARCHAR(36) NOT NULL COMMENT '依赖的任务 ID（外键）',
  `dependency_type` VARCHAR(50) NOT NULL COMMENT '依赖类型：predecessor-前置任务，successor-后置任务',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_task_dependency` (`task_id`, `depends_on_task_id`, `dependency_type`),
  KEY `idx_task_id` (`task_id`),
  KEY `idx_depends_on_task_id` (`depends_on_task_id`),
  CONSTRAINT `fk_task_dependencies_task_id` FOREIGN KEY (`task_id`) REFERENCES `tasks` (`task_id`) ON DELETE CASCADE COMMENT '关联 tasks 表的 task_id 字段',
  CONSTRAINT `fk_task_dependencies_depends_on_task_id` FOREIGN KEY (`depends_on_task_id`) REFERENCES `tasks` (`task_id`) ON DELETE CASCADE COMMENT '关联 tasks 表的 task_id 字段'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='任务依赖表';

-- 创建任务模板表
CREATE TABLE `task_templates` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '模板 ID（主键）',
  `template_id` VARCHAR(36) NOT NULL COMMENT '模板唯一标识（UUID）',
  `template_name` VARCHAR(255) NOT NULL COMMENT '模板名称',
  `template_description` TEXT COMMENT '模板描述',
  `template_type` VARCHAR(50) NOT NULL COMMENT '模板类型：stock_selection-选股模板，batch_backtest-批量回测模板，single_backtest-个股回测模板',
  `template_config` TEXT NOT NULL COMMENT '模板配置（JSON 格式字符串）',
  `is_public` BIGINT UNSIGNED DEFAULT 0 COMMENT '是否公开：0-私有，1-公开',
  `created_by` VARCHAR(36) COMMENT '创建用户 ID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_template_id` (`template_id`),
  KEY `idx_template_type` (`template_type`),
  KEY `idx_is_public` (`is_public`),
  KEY `idx_created_by` (`created_by`),
  KEY `idx_template_name` (`template_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='任务模板表';

-- 初始化完成
SELECT 'Database initialization completed successfully!' AS message;
```

---

## 6. 数据库维护

-- ### 6.1 分区维护

-- #### 6.1.1 日志表分区维护
-- ```sql
-- -- 添加新的月度分区（每月执行一次）
-- ALTER TABLE task_logs ADD PARTITION (
--   PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01'))
-- );

-- -- 删除旧分区（保留最近12个月）
-- ALTER TABLE task_logs DROP PARTITION p202401;
-- ```

-- #### 6.1.2 交易明细表分区维护
-- ```sql
-- -- 添加新的年度分区（每年执行一次）
-- ALTER TABLE trade_details ADD PARTITION (
--   PARTITION p2029 VALUES LESS THAN (TO_DAYS('2030-01-01'))
-- );

-- -- 删除旧分区（保留最近5年）
-- ALTER TABLE trade_details DROP PARTITION p2020;
-- ```

### 6.2 数据备份

#### 6.2.1 全量备份脚本
```bash
#!/bin/bash
# 全量备份脚本
DATE=$(date +%Y%m%d)
BACKUP_DIR="/data/backup/mysql"
DB_NAME="stock_trade_system"

mysqldump -u root -p$MYSQL_PASSWORD \
  --single-transaction \
  --routines \
  --triggers \
  --events \
  $DB_NAME > $BACKUP_DIR/$DB_NAME_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/$DB_NAME_$DATE.sql

# 删除30天前的备份
find $BACKUP_DIR -name "$DB_NAME_*.sql.gz" -mtime +30 -delete
```

#### 6.2.2 增量备份脚本
```bash
#!/bin/bash
# 增量备份脚本（基于binlog）
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/data/backup/mysql/incremental"

# 刷新binlog
mysql -u root -p$MYSQL_PASSWORD -e "FLUSH LOGS;"

# 复制binlog文件
cp /var/lib/mysql/mysql-bin.* $BACKUP_DIR/

# 删除7天前的增量备份
find $BACKUP_DIR -name "mysql-bin.*" -mtime +7 -delete
```

### 6.3 性能优化

#### 6.3.1 定期分析表
```sql
-- 分析表统计信息
ANALYZE TABLE tasks;
ANALYZE TABLE task_executions;
ANALYZE TABLE task_logs;
ANALYZE TABLE stock_selection_results;
ANALYZE TABLE backtest_results;
ANALYZE TABLE trade_details;
```

#### 6.3.2 定期优化表
```sql
-- 优化表碎片
OPTIMIZE TABLE tasks;
OPTIMIZE TABLE task_executions;
OPTIMIZE TABLE stock_selection_results;
OPTIMIZE TABLE backtest_results;
```

### 6.4 监控查询

#### 6.4.1 查看表大小
```sql
SELECT 
  table_name AS '表名',
  ROUND(((data_length + index_length) / 1024 / 1024), 2) AS '大小(MB)',
  table_rows AS '行数'
FROM information_schema.TABLES
WHERE table_schema = 'stock_trade_system'
ORDER BY (data_length + index_length) DESC;
```

#### 6.4.2 查看索引使用情况
```sql
SELECT 
  table_name,
  index_name,
  cardinality,
  ROUND(cardinality / table_rows * 100, 2) AS 'selectivity%'
FROM information_schema.STATISTICS
WHERE table_schema = 'stock_trade_system'
ORDER BY table_name, index_name;
```

#### 6.4.3 查看慢查询
```sql
-- 启用慢查询日志
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow-query.log';

-- 查看慢查询统计
SELECT * FROM mysql.slow_log
ORDER BY query_time DESC
LIMIT 10;
```

---

## 7. 附录

### 7.1 数据字典

#### 7.1.1 任务状态枚举
| 值 | 说明 |
|----|------|
| pending | 待执行 |
| running | 执行中 |
| completed | 已完成 |
| failed | 失败 |
| cancelled | 已取消 |

#### 7.1.2 任务类型枚举
| 值 | 说明 |
|----|------|
| stock_selection | 选股任务 |
| batch_backtest | 批量回测任务 |
| single_backtest | 个股回测任务 |

#### 7.1.3 日志级别枚举
| 值 | 说明 |
|----|------|
| DEBUG | 调试信息 |
| INFO | 一般信息 |
| WARNING | 警告信息 |
| ERROR | 错误信息 |

#### 7.1.4 交易类型枚举
| 值 | 说明 |
|----|------|
| buy | 买入 |
| sell | 卖出 |

#### 7.1.5 依赖类型枚举
| 值 | 说明 |
|----|------|
| predecessor | 前置任务 |
| successor | 后置任务 |

### 7.2 常见问题

#### 7.2.1 如何重置表的自增ID？
```sql
-- 重置tasks表的自增ID
ALTER TABLE tasks AUTO_INCREMENT = 1;
```

#### 7.2.2 如何清空表数据？
```sql
-- 清空表数据（保留表结构）
TRUNCATE TABLE task_logs;

-- 清空表数据（保留表结构和自增ID）
DELETE FROM task_logs;
ALTER TABLE task_logs AUTO_INCREMENT = 1;
```

#### 7.2.3 如何查看外键约束？
```sql
SELECT 
  TABLE_NAME,
  CONSTRAINT_NAME,
  COLUMN_NAME,
  REFERENCED_TABLE_NAME,
  REFERENCED_COLUMN_NAME
FROM information_schema.KEY_COLUMN_USAGE
WHERE TABLE_SCHEMA = 'stock_trade_system'
  AND REFERENCED_TABLE_NAME IS NOT NULL;
```

#### 7.2.4 如何查看分区信息？
```sql
SELECT 
  TABLE_NAME,
  PARTITION_NAME,
  PARTITION_EXPRESSION,
  PARTITION_DESCRIPTION,
  TABLE_ROWS
FROM information_schema.PARTITIONS
WHERE TABLE_SCHEMA = 'stock_trade_system'
  AND TABLE_NAME IN ('task_logs', 'trade_details')
ORDER BY PARTITION_ORDINAL_POSITION;
```

### 7.3 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0 | 2024-01-01 | 初始版本，完成9张核心表设计 |
